<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">Raise Claim</h5>

          <div
            *ngIf="successMessage"
            class="alert alert-success alert-dismissible fade show py-2"
            role="alert"
          >
            {{ successMessage }}
            <button type="button" class="btn-close" (click)="successMessage = ''"></button>
          </div>

          <div
            *ngIf="error"
            class="alert alert-danger alert-dismissible fade show py-2"
            role="alert"
          >
            {{ error }}
            <button type="button" class="btn-close" (click)="error = ''"></button>
          </div>

          <div *ngIf="loading" class="alert alert-info py-2">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading data...
          </div>

          <form [formGroup]="form" (ngSubmit)="submit()">
            <!-- Customer Policy -->
            <div class="mb-2">
              <label class="form-label">Customer Policy <span class="text-danger">*</span></label>
              <select
                class="form-select"
                formControlName="customerPolicyId"
                [class.is-invalid]="
                  f['customerPolicyId'].invalid &&
                  (f['customerPolicyId'].dirty || f['customerPolicyId'].touched || submitted)
                "
              >
                <option value="">Select assignment</option>
                <option *ngFor="let a of assignments$ | async" [value]="a.id">
                  CP#{{ a.id }} - {{ a.customer.firstName }} {{ a.customer.lastName }} /
                  {{ a.policy.policyName }} (Coverage: ₹{{ a.policy.coverageAmount | number }})
                </option>
              </select>
              <div
                *ngIf="
                  f['customerPolicyId'].invalid &&
                  (f['customerPolicyId'].dirty || f['customerPolicyId'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['customerPolicyId'].errors?.['required']">
                  Please select a customer policy
                </div>
              </div>
            </div>

            <!-- Claim Amount -->
            <div class="mb-2">
              <label class="form-label">Claim Amount (₹) <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input
                  type="number"
                  class="form-control"
                  formControlName="claimAmount"
                  min="1000"
                  step="100"
                  [class.is-invalid]="
                    f['claimAmount'].invalid &&
                    (f['claimAmount'].dirty || f['claimAmount'].touched || submitted)
                  "
                />
              </div>
              <div
                *ngIf="
                  f['claimAmount'].invalid &&
                  (f['claimAmount'].dirty || f['claimAmount'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['claimAmount'].errors?.['required']">Claim amount is required</div>
                <div *ngIf="f['claimAmount'].errors?.['min']">Minimum claim amount is ₹1</div>
                <div *ngIf="f['claimAmount'].errors?.['positiveNumber']">
                  Claim amount must be a positive number
                </div>
                <div *ngIf="f['claimAmount'].errors?.['amountRange']">
                  Claim amount must be between ₹1,000 and ₹1,00,00,000
                </div>
              </div>
            </div>

            <!-- Claim Date -->
            <div class="mb-2">
              <label class="form-label">Claim Date <span class="text-danger">*</span></label>
              <input
                type="date"
                class="form-control"
                formControlName="claimDate"
                [max]="today"
                [class.is-invalid]="
                  f['claimDate'].invalid &&
                  (f['claimDate'].dirty || f['claimDate'].touched || submitted)
                "
              />
              <div
                *ngIf="
                  f['claimDate'].invalid &&
                  (f['claimDate'].dirty || f['claimDate'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['claimDate'].errors?.['required']">Claim date is required</div>
                <div *ngIf="f['claimDate'].errors?.['pastDate']">
                  Claim date cannot be in the future
                </div>
              </div>
            </div>

            <!-- Claim Status -->
            <div class="mb-2">
              <label class="form-label">Status <span class="text-danger">*</span></label>
              <select
                class="form-select"
                formControlName="claimStatus"
                [class.is-invalid]="
                  f['claimStatus'].invalid &&
                  (f['claimStatus'].dirty || f['claimStatus'].touched || submitted)
                "
              >
                <option *ngFor="let status of claimStatuses" [value]="status">{{ status }}</option>
              </select>
              <div
                *ngIf="
                  f['claimStatus'].invalid &&
                  (f['claimStatus'].dirty || f['claimStatus'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['claimStatus'].errors?.['required']">Claim status is required</div>
              </div>
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label class="form-label">Description <span class="text-danger">*</span></label>
              <textarea
                rows="3"
                class="form-control"
                formControlName="description"
                placeholder="Describe the claim details, incident, and required documentation"
                [class.is-invalid]="
                  f['description'].invalid &&
                  (f['description'].dirty || f['description'].touched || submitted)
                "
              ></textarea>
              <div
                *ngIf="
                  f['description'].invalid &&
                  (f['description'].dirty || f['description'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['description'].errors?.['required']">Description is required</div>
                <div *ngIf="f['description'].errors?.['minlength']">
                  Description must be at least 10 characters
                </div>
                <div *ngIf="f['description'].errors?.['maxlength']">
                  Description cannot exceed 500 characters
                </div>
              </div>
              <small class="form-text text-muted">
                {{ (f['description'].value || '').length }}/500 characters
              </small>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-secondary flex-grow-1"
                type="button"
                (click)="resetForm()"
                [disabled]="form.pristine"
              >
                Reset
              </button>
              <button
                class="btn btn-dark flex-grow-1"
                type="submit"
                [disabled]="form.invalid || loading"
              >
                Raise Claim
              </button>
            </div>

            <!-- Form Validation Summary -->
            <div *ngIf="form.invalid && submitted" class="alert alert-danger mt-3 py-2">
              <small><strong>Please fix the errors above before submitting.</strong></small>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Claims</h5>
        <div>
          <span class="badge text-bg-secondary me-2">Total: {{ (claims$ | async)?.length }}</span>
          <span *ngIf="countClaimsByStatus('PENDING') > 0" class="badge text-bg-warning me-2"
            >Pending: {{ countClaimsByStatus('PENDING') }}</span
          >
          <span *ngIf="countClaimsByStatus('APPROVED') > 0" class="badge text-bg-success me-2"
            >Approved: {{ countClaimsByStatus('APPROVED') }}</span
          >
          <span *ngIf="countClaimsByStatus('REJECTED') > 0" class="badge text-bg-danger"
            >Rejected: {{ countClaimsByStatus('REJECTED') }}</span
          >
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4">
        <div *ngIf="loading" class="p-4 text-muted text-center">
          <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
          Loading claims...
        </div>
        <ng-container *ngIf="!loading">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Customer Policy</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of claims$ | async; trackBy: trackById">
                  <td>{{ c.id }}</td>
                  <td>
                    CP#{{ c.customerPolicy.id }}<br />
                    <small class="text-muted">
                      {{ c.customerPolicy.customer.firstName }}
                      {{ c.customerPolicy.customer.lastName }} /
                      {{ c.customerPolicy.policy.policyName }}
                    </small>
                  </td>
                  <td>
                    <strong>₹{{ c.claimAmount | number }}</strong>
                  </td>
                  <td>{{ c.claimDate }}</td>
                  <td>
                    <ng-container [ngSwitch]="c.claimStatus">
                      <span *ngSwitchCase="'PENDING'" class="badge text-bg-warning">{{
                        c.claimStatus
                      }}</span>
                      <span *ngSwitchCase="'APPROVED'" class="badge text-bg-success">{{
                        c.claimStatus
                      }}</span>
                      <span *ngSwitchCase="'REJECTED'" class="badge text-bg-danger">{{
                        c.claimStatus
                      }}</span>
                      <span *ngSwitchCase="'UNDER_REVIEW'" class="badge text-bg-info">{{
                        c.claimStatus
                      }}</span>
                      <span *ngSwitchDefault class="badge text-bg-secondary">{{
                        c.claimStatus
                      }}</span>
                    </ng-container>
                  </td>
                  <td class="small text-muted">
                    {{
                      c.description.length > 50
                        ? c.description.substring(0, 50) + '...'
                        : c.description
                    }}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-danger" (click)="delete(c.id)">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                <tr *ngIf="(claims$ | async)?.length === 0">
                  <td colspan="7" class="text-center text-muted py-4">No claims yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>