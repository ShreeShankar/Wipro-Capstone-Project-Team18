<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">Make Payment</h5>

          <div
            *ngIf="successMessage"
            class="alert alert-success alert-dismissible fade show py-2"
            role="alert"
          >
            {{ successMessage }}
            <button type="button" class="btn-close" (click)="successMessage = ''"></button>
          </div>

          <div
            *ngIf="error"
            class="alert alert-danger alert-dismissible fade show py-2"
            role="alert"
          >
            {{ error }}
            <button type="button" class="btn-close" (click)="error = ''"></button>
          </div>

          <div *ngIf="loading" class="alert alert-info py-2">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading data...
          </div>

          <form [formGroup]="form" (ngSubmit)="submit()">
            <!-- Customer Policy -->
            <div class="mb-2">
              <label class="form-label">Customer Policy <span class="text-danger">*</span></label>
              <select
                class="form-select"
                formControlName="customerPolicyId"
                [class.is-invalid]="
                  f['customerPolicyId'].invalid &&
                  (f['customerPolicyId'].dirty || f['customerPolicyId'].touched || submitted)
                "
              >
                <option value="">Select assignment</option>
                <option *ngFor="let a of assignments$ | async" [value]="a.id">
                  CP#{{ a.id }} - {{ a.customer.firstName }} {{ a.customer.lastName }} /
                  {{ a.policy.policyName }} (₹{{ a.premiumAmount }})
                </option>
              </select>
              <div
                *ngIf="
                  f['customerPolicyId'].invalid &&
                  (f['customerPolicyId'].dirty || f['customerPolicyId'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['customerPolicyId'].errors?.['required']">
                  Please select a customer policy
                </div>
              </div>
            </div>

            <!-- Amount -->
            <div class="mb-2">
              <label class="form-label">Amount (₹) <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text">₹</span>
                <input
                  type="number"
                  class="form-control"
                  formControlName="amount"
                  min="100"
                  step="10"
                  [class.is-invalid]="
                    f['amount'].invalid && (f['amount'].dirty || f['amount'].touched || submitted)
                  "
                />
              </div>
              <div
                *ngIf="
                  f['amount'].invalid && (f['amount'].dirty || f['amount'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['amount'].errors?.['required']">Amount is required</div>
                <div *ngIf="f['amount'].errors?.['min']">Minimum amount is ₹1</div>
                <div *ngIf="f['amount'].errors?.['positiveNumber']">
                  Amount must be a positive number
                </div>
                <div *ngIf="f['amount'].errors?.['amountRange']">
                  Amount must be between ₹100 and ₹10,00,000
                </div>
              </div>
            </div>

            <!-- Payment Date -->
            <div class="mb-2">
              <label class="form-label">Payment Date <span class="text-danger">*</span></label>
              <input
                type="date"
                class="form-control"
                formControlName="paymentDate"
                [max]="today"
                [class.is-invalid]="
                  f['paymentDate'].invalid &&
                  (f['paymentDate'].dirty || f['paymentDate'].touched || submitted)
                "
              />
              <div
                *ngIf="
                  f['paymentDate'].invalid &&
                  (f['paymentDate'].dirty || f['paymentDate'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['paymentDate'].errors?.['required']">Payment date is required</div>
                <div *ngIf="f['paymentDate'].errors?.['pastDate']">
                  Payment date cannot be in the future
                </div>
              </div>
            </div>

            <div class="row g-2">
              <!-- Payment Mode -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Mode <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  formControlName="paymentMode"
                  [class.is-invalid]="
                    f['paymentMode'].invalid &&
                    (f['paymentMode'].dirty || f['paymentMode'].touched || submitted)
                  "
                >
                  <option *ngFor="let mode of paymentModes" [value]="mode">{{ mode }}</option>
                </select>
                <div
                  *ngIf="
                    f['paymentMode'].invalid &&
                    (f['paymentMode'].dirty || f['paymentMode'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['paymentMode'].errors?.['required']">Payment mode is required</div>
                </div>
              </div>

              <!-- Payment Status -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Status <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  formControlName="paymentStatus"
                  [class.is-invalid]="
                    f['paymentStatus'].invalid &&
                    (f['paymentStatus'].dirty || f['paymentStatus'].touched || submitted)
                  "
                >
                  <option *ngFor="let status of paymentStatuses" [value]="status">
                    {{ status }}
                  </option>
                </select>
                <div
                  *ngIf="
                    f['paymentStatus'].invalid &&
                    (f['paymentStatus'].dirty || f['paymentStatus'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['paymentStatus'].errors?.['required']">
                    Payment status is required
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-secondary flex-grow-1"
                type="button"
                (click)="resetForm()"
                [disabled]="form.pristine"
              >
                Reset
              </button>
              <button
                class="btn btn-dark flex-grow-1"
                type="submit"
                [disabled]="form.invalid || loading"
              >
                Record Payment
              </button>
            </div>

            <!-- Form Validation Summary -->
            <div *ngIf="form.invalid && submitted" class="alert alert-danger mt-3 py-2">
              <small><strong>Please fix the errors above before submitting.</strong></small>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Payments</h5>
        <div>
          <span class="badge text-bg-secondary me-2">Total: {{ (payments$ | async)?.length }}</span>
          <span *ngIf="calculateTotalPayments() > 0" class="badge text-bg-success me-2"
            >Paid: ₹{{ calculateTotalPayments() | number }}</span
          >
          <span *ngIf="calculatePendingPayments() > 0" class="badge text-bg-warning"
            >Pending: ₹{{ calculatePendingPayments() | number }}</span
          >
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4">
        <div *ngIf="loading" class="p-4 text-muted text-center">
          <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
          Loading payments...
        </div>
        <ng-container *ngIf="!loading">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Customer Policy</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Mode</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let p of payments$ | async; trackBy: trackById">
                  <td>{{ p.id }}</td>
                  <td>
                    CP#{{ p.customerPolicy.id }}<br />
                    <small class="text-muted">
                      {{ p.customerPolicy.customer.firstName }}
                      {{ p.customerPolicy.customer.lastName }} /
                      {{ p.customerPolicy.policy.policyName }}
                    </small>
                  </td>
                  <td>
                    <strong>₹{{ p.amount | number }}</strong>
                  </td>
                  <td>{{ p.paymentDate }}</td>
                  <td>{{ p.paymentMode }}</td>
                  <td>
                    <ng-container [ngSwitch]="p.paymentStatus">
                      <span *ngSwitchCase="'PAID'" class="badge text-bg-success">{{
                        p.paymentStatus
                      }}</span>
                      <span *ngSwitchCase="'PENDING'" class="badge text-bg-warning">{{
                        p.paymentStatus
                      }}</span>
                      <span *ngSwitchCase="'FAILED'" class="badge text-bg-danger">{{
                        p.paymentStatus
                      }}</span>
                      <span *ngSwitchDefault class="badge text-bg-secondary">{{
                        p.paymentStatus
                      }}</span>
                    </ng-container>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-danger" (click)="delete(p.id)">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                <tr *ngIf="(payments$ | async)?.length === 0">
                  <td colspan="7" class="text-center text-muted py-4">No payments yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>