<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
          <h5 class="fw-bold mb-3">Assign Policy</h5>

          <div
            *ngIf="successMessage"
            class="alert alert-success alert-dismissible fade show py-2"
            role="alert"
          >
            {{ successMessage }}
            <button type="button" class="btn-close" (click)="successMessage = ''"></button>
          </div>

          <div
            *ngIf="error"
            class="alert alert-danger alert-dismissible fade show py-2"
            role="alert"
          >
            {{ error }}
            <button type="button" class="btn-close" (click)="error = ''"></button>
          </div>

          <div *ngIf="loading" class="alert alert-info py-2">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading data...
          </div>

          <form [formGroup]="form" (ngSubmit)="submit()">
            <!-- Customer -->
            <div class="mb-2">
              <label class="form-label">Customer <span class="text-danger">*</span></label>
              <select
                class="form-select"
                formControlName="customerId"
                [class.is-invalid]="
                  f['customerId'].invalid &&
                  (f['customerId'].dirty || f['customerId'].touched || submitted)
                "
              >
                <option value="">Select customer</option>
                <option *ngFor="let c of customers$ | async" [value]="c.id">
                  {{ c.firstName }} {{ c.lastName }} (ID: {{ c.id }})
                </option>
              </select>
              <div
                *ngIf="
                  f['customerId'].invalid &&
                  (f['customerId'].dirty || f['customerId'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['customerId'].errors?.['required']">Please select a customer</div>
              </div>
            </div>

            <!-- Policy -->
            <div class="mb-2">
              <label class="form-label">Policy <span class="text-danger">*</span></label>
              <select
                class="form-select"
                formControlName="policyId"
                [class.is-invalid]="
                  f['policyId'].invalid &&
                  (f['policyId'].dirty || f['policyId'].touched || submitted)
                "
              >
                <option value="">Select policy</option>
                <option *ngFor="let p of policies$ | async" [value]="p.id">
                  {{ p.policyName }} (₹{{ p.premiumAmount | number }} - {{ p.policyType }})
                </option>
              </select>
              <div
                *ngIf="
                  f['policyId'].invalid &&
                  (f['policyId'].dirty || f['policyId'].touched || submitted)
                "
                class="invalid-feedback"
              >
                <div *ngIf="f['policyId'].errors?.['required']">Please select a policy</div>
              </div>
            </div>

            <div class="row g-2">
              <!-- Start Date -->
              <div class="col-md-6 mb-2">
                <label class="form-label">Start Date <span class="text-danger">*</span></label>
                <input
                  type="date"
                  class="form-control"
                  formControlName="startDate"
                  [min]="today"
                  [class.is-invalid]="
                    f['startDate'].invalid &&
                    (f['startDate'].dirty || f['startDate'].touched || submitted)
                  "
                />
                <div
                  *ngIf="
                    f['startDate'].invalid &&
                    (f['startDate'].dirty || f['startDate'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['startDate'].errors?.['required']">Start date is required</div>
                  <div *ngIf="f['startDate'].errors?.['futureDate']">
                    Start date must be today or in the future
                  </div>
                </div>
              </div>

              <!-- End Date -->
              <div class="col-md-6 mb-2">
                <label class="form-label">End Date <span class="text-danger">*</span></label>
                <input
                  type="date"
                  class="form-control"
                  formControlName="endDate"
                  [min]="today"
                  [class.is-invalid]="
                    f['endDate'].invalid &&
                    (f['endDate'].dirty || f['endDate'].touched || submitted)
                  "
                />
                <div
                  *ngIf="
                    f['endDate'].invalid &&
                    (f['endDate'].dirty || f['endDate'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['endDate'].errors?.['required']">End date is required</div>
                  <div *ngIf="f['endDate'].errors?.['futureDate']">
                    End date must be today or in the future
                  </div>
                  <div *ngIf="f['endDate'].errors?.['dateComparison']">
                    End date must be after start date
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-2">
              <!-- Status -->
              <div class="col-md-6 mb-2">
                <label class="form-label">Status <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  formControlName="status"
                  [class.is-invalid]="
                    f['status'].invalid && (f['status'].dirty || f['status'].touched || submitted)
                  "
                >
                  <option value="ACTIVE">ACTIVE</option>
                  <option value="PENDING">PENDING</option>
                  <option value="EXPIRED">EXPIRED</option>
                </select>
                <div
                  *ngIf="
                    f['status'].invalid && (f['status'].dirty || f['status'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['status'].errors?.['required']">Status is required</div>
                </div>
              </div>

              <!-- Premium -->
              <div class="col-md-6 mb-3">
                <label class="form-label">Premium (₹) <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">₹</span>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="premiumAmount"
                    min="500"
                    step="100"
                    [class.is-invalid]="
                      f['premiumAmount'].invalid &&
                      (f['premiumAmount'].dirty || f['premiumAmount'].touched || submitted)
                    "
                  />
                </div>
                <div
                  *ngIf="
                    f['premiumAmount'].invalid &&
                    (f['premiumAmount'].dirty || f['premiumAmount'].touched || submitted)
                  "
                  class="invalid-feedback"
                >
                  <div *ngIf="f['premiumAmount'].errors?.['required']">
                    Premium amount is required
                  </div>
                  <div *ngIf="f['premiumAmount'].errors?.['min']">Minimum premium is ₹1</div>
                  <div *ngIf="f['premiumAmount'].errors?.['positiveNumber']">
                    Premium must be a positive number
                  </div>
                  <div *ngIf="f['premiumAmount'].errors?.['amountRange']">
                    Premium must be between ₹500 and ₹10,00,000
                  </div>
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-secondary flex-grow-1"
                type="button"
                (click)="resetForm()"
                [disabled]="form.pristine"
              >
                Reset
              </button>
              <button
                class="btn btn-dark flex-grow-1"
                type="submit"
                [disabled]="form.invalid || loading"
              >
                Assign Policy
              </button>
            </div>

            <!-- Form Validation Summary -->
            <div *ngIf="form.invalid && submitted" class="alert alert-danger mt-3 py-2">
              <small><strong>Please fix the errors above before submitting.</strong></small>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Assignments</h5>
        <span class="badge text-bg-secondary">{{ (assignments$ | async)?.length }}</span>
      </div>

      <div class="card border-0 shadow-sm rounded-4">
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Policy</th>
                <th>Status</th>
                <th>Dates</th>
                <th>Premium</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let a of assignments$ | async; trackBy: trackById">
                <td>{{ a.id }}</td>
                <td class="fw-semibold">{{ a.customer.firstName }} {{ a.customer.lastName }}</td>
                <td>{{ a.policy.policyName }}</td>
                <td>
                  <span
                    class="badge"
                    [ngClass]="{
                      'text-bg-success': a.status === 'ACTIVE',
                      'text-bg-warning': a.status === 'PENDING',
                      'text-bg-secondary': a.status === 'EXPIRED',
                    }"
                    >{{ a.status }}</span
                  >
                </td>
                <td class="small text-muted">{{ a.startDate }} → {{ a.endDate }}</td>
                <td>₹{{ a.premiumAmount | number }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-danger" (click)="delete(a.id)">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </td>
              </tr>
              <tr *ngIf="(assignments$ | async)?.length === 0">
                <td colspan="7" class="text-center text-muted py-4">No assignments yet</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>